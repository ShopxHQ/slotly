{% schema %}
{
  "name": "Delivery Date Picker",
  "target": "body",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Select delivery date"
    },
    {
      "type": "checkbox",
      "id": "show_time",
      "label": "Show time picker",
      "default": true
    }
  ]
}
{% endschema %}

<style>
.delivery-date-wrapper {
  margin: 12px 0;
  font-family: inherit;
}

.delivery-date-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
}

.delivery-date-input-wrapper {
  position: relative;
  z-index: 999999;
}

.delivery-date-input {
  width: 100%;
  padding: 12px 42px 12px 12px;
  border-radius: 10px;
  border: 1px solid #d9d9d9;
  font-size: 14px;
  background: #fff;
  cursor: pointer;
}

.calendar-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

.delivery-calendar-popup {
  position: absolute;
  bottom: 110%;
  left: 0;
  width: 280px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  padding: 10px;
  z-index: 999999;
  display: none;
}

.calendar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
}

.calendar-header button {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
}

.month-label {
  font-weight: 600;
  font-size: 14px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.calendar-weekday {
  text-align: center;
  font-size: 11px;
  font-weight: 500;
  color: #777;
}

.calendar-day {
  text-align: center;
  padding: 8px 0;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
}

.calendar-day:hover {
  background: #f2f2f2;
}

.calendar-day.disabled {
  color: #bbb;
  cursor: not-allowed;
}

.calendar-day.active {
  background: #1a73e8;
  color: #fff;
}

.delivery-time-input {
  margin-top: 10px;
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.delivery-date-note {
  margin-top: 6px;
  font-size: 12px;
  color: #666;
}
</style>

<script>
(function () {

  /* ===============================
     LOAD METAFIELD CONFIG
  =============================== */
  let config = {};
  try {
    const raw = {{ shop.metafields.delivery_config.settings.value | json }};
    config = raw && typeof raw === 'string' ? JSON.parse(raw) : (raw || {});
  } catch (e) {
    config = {};
  }

  const DAY_MAP = {
    Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3,
    Thursday: 4, Friday: 5, Saturday: 6
  };

  function isBlocked(date) {
    const dateStr = date.toISOString().split('T')[0];
    const day = date.getDay();
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const earliestDays = config.earliestDays ? parseInt(config.earliestDays) : 0;
    const furthestDays = config.furthestDays ? parseInt(config.furthestDays) : null;

    const earliestDate = new Date(today);
    earliestDate.setDate(today.getDate() + earliestDays);

    if (date < earliestDate) return true;

    if (furthestDays !== null) {
      const furthestDate = new Date(today);
      furthestDate.setDate(today.getDate() + furthestDays);
      if (date > furthestDate) return true;
    }

    if (Array.isArray(config.availableDays) && config.availableDays.length) {
      const allowed = config.availableDays.map(d => DAY_MAP[d]);
      if (!allowed.includes(day)) return true;
    }

    if (Array.isArray(config.blockedDateRules)) {
      for (const rule of config.blockedDateRules) {
        if (rule.applyTo === 'single' && rule.singleDate === dateStr) return true;
        if (
          rule.applyTo === 'range' &&
          rule.fromDate &&
          rule.toDate &&
          dateStr >= rule.fromDate &&
          dateStr <= rule.toDate
        ) return true;
      }
    }

    return false;
  }

  function init() {
    if (document.querySelector('.delivery-date-wrapper')) return;

    const checkoutBtn =
      document.querySelector('form[action="/cart"] button[name="checkout"]') ||
      document.querySelector('[name="checkout"]') ||
      document.querySelector('.cart__checkout-button');

    if (!checkoutBtn || !checkoutBtn.parentElement) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'delivery-date-wrapper';

    wrapper.innerHTML = `
      <label class="delivery-date-label">{{ settings.title | escape }}</label>
      <div class="delivery-date-input-wrapper">
        <input class="delivery-date-input" readonly placeholder="Select delivery date">
        <span class="calendar-icon">ðŸ“…</span>
        <div class="delivery-calendar-popup"></div>
      </div>
      {% if settings.show_time %}
        <input type="time" class="delivery-time-input">
      {% endif %}
      <div class="delivery-date-note">
        Please select an available delivery date.
      </div>
    `;

    const input = wrapper.querySelector('.delivery-date-input');
    const popup = wrapper.querySelector('.delivery-calendar-popup');
    const timeInput = wrapper.querySelector('.delivery-time-input');

    /* Prevent drawer close */
    popup.addEventListener('click', e => e.stopPropagation());

    let current = new Date();

    function renderCalendar() {
      popup.innerHTML = '';

      const header = document.createElement('div');
      header.className = 'calendar-header';
      header.innerHTML = `
        <button class="prev">â€¹</button>
        <span class="month-label">
          ${current.toLocaleString('default', { month: 'long', year: 'numeric' })}
        </span>
        <button class="next">â€º</button>
      `;

      const grid = document.createElement('div');
      grid.className = 'calendar-grid';

      ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d => {
        const wd = document.createElement('div');
        wd.className = 'calendar-weekday';
        wd.textContent = d;
        grid.appendChild(wd);
      });

      const firstDay = new Date(current.getFullYear(), current.getMonth(), 1).getDay();
      const daysInMonth = new Date(current.getFullYear(), current.getMonth() + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        grid.appendChild(document.createElement('div'));
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(current.getFullYear(), current.getMonth(), d);
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        cell.textContent = d;

        if (isBlocked(date)) {
          cell.classList.add('disabled');
        } else {
          cell.onclick = (e) => {
            e.stopPropagation();
            input.value = date.toLocaleDateString('en-GB');
            popup.style.display = 'none';
            save(date);
          };
        }

        grid.appendChild(cell);
      }

      popup.appendChild(header);
      popup.appendChild(grid);

      header.querySelector('.prev').onclick = (e) => {
        e.stopPropagation();
        current.setMonth(current.getMonth() - 1);
        renderCalendar();
      };

      header.querySelector('.next').onclick = (e) => {
        e.stopPropagation();
        current.setMonth(current.getMonth() + 1);
        renderCalendar();
      };
    }

    function save(date) {
      fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          attributes: {
            'Delivery Date': date.toISOString().split('T')[0],
            'Delivery Time': timeInput ? timeInput.value : ''
          }
        })
      });
    }

    input.addEventListener('click', (e) => {
      e.stopPropagation();
      popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
      renderCalendar();
    });

    /* âœ… Correct outside-click handler */
    document.addEventListener('click', (e) => {
      if (!wrapper.contains(e.target)) {
        popup.style.display = 'none';
      }
    });

    checkoutBtn.parentElement.insertBefore(wrapper, checkoutBtn);
  }

  init();
  new MutationObserver(init).observe(document.body, { childList: true, subtree: true });

})();
</script>
