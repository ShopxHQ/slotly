{% schema %}
{
  "name": "Pickup From Store",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Pickup From Store"
    },
    {
      "type": "text",
      "id": "note",
      "label": "Helper Text",
      "default": "Select your preferred pickup location."
    }
  ]
}
{% endschema %}

<style>
.pickup-store-wrapper {
  margin: 16px 0;
  padding: 16px;
  border: 1px solid #e1e1e1;
  border-radius: 10px;
  background: #ffffff;
}

.pickup-store-label {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 8px;
  display: block;
  color: #111;
}

.pickup-store-select {
  width: 100%;
  padding: 12px 14px;
  border-radius: 8px;
  border: 1px solid #cfcfcf;
  background-color: #fff;
  font-size: 14px;
  line-height: 1.4;
  cursor: pointer;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.pickup-store-select:focus {
  outline: none;
  border-color: #1773ff;
  box-shadow: 0 0 0 3px rgba(23, 115, 255, 0.15);
}

.pickup-store-note {
  margin-top: 8px;
  font-size: 12px;
  color: #6b6b6b;
}

/* Placeholder color */
.pickup-store-select:has(option[value=""]:checked) {
  color: #888;
}
</style>

<script>
(function () {
  let storeRules = [];

  try {
    const metafieldValue = {{ shop.metafields.store_config.store_rules.value | default: '[]' | json }};
    if (typeof metafieldValue === 'string') {
      storeRules = JSON.parse(metafieldValue);
    } else if (Array.isArray(metafieldValue)) {
      storeRules = metafieldValue;
    }
  } catch (e) {
    console.error('[Pickup Store] Metafield parse error:', e);
    storeRules = [];
  }

  const CONFIG = {
    title: {{ settings.title | json }},
    note: {{ settings.note | json }},
    storeRules: storeRules
  };

  function init() {
    if (document.querySelector('.pickup-store-wrapper')) return;

    const checkoutBtn =
      document.querySelector('form[action="/cart"] button[name="checkout"]') ||
      document.querySelector('[name="checkout"]') ||
      document.querySelector('.cart__checkout-button');

    if (!checkoutBtn || !checkoutBtn.parentElement) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'pickup-store-wrapper';

    const labelHTML = CONFIG.title && CONFIG.title.trim()
      ? `<label class="pickup-store-label">${CONFIG.title}</label>`
      : '';

    const optionsHTML = Array.isArray(CONFIG.storeRules)
      ? CONFIG.storeRules
          .filter(store => store.active)
          .map(store => {
            const open = store.openTime || '—';
            const close = store.closeTime || '—';
            const tz = store.timezone || '—';

            return `
              <option value="${store.storeName}">
                ${store.storeName} — ${open} to ${close} (${tz})
              </option>
            `;
          })
          .join('')
      : '';

    wrapper.innerHTML = `
      ${labelHTML}
      <select class="pickup-store-select" required>
        <option value="" disabled selected hidden>Select a store</option>
        ${optionsHTML}
      </select>
      ${
        CONFIG.note && CONFIG.note.trim()
          ? `<div class="pickup-store-note">${CONFIG.note}</div>`
          : ''
      }
    `;

    const select = wrapper.querySelector('.pickup-store-select');

    /* Load saved value */
    fetch('/cart.js')
      .then(r => r.json())
      .then(cart => {
        if (cart.attributes && cart.attributes['Pickup Store']) {
          select.value = cart.attributes['Pickup Store'];
        }
      });

    /* Save on change */
    select.addEventListener('change', () => {
      const selectedStore = select.value;
      
      const updateData = {
        attributes: {
          'Pickup Store': selectedStore
        }
      };

      if (selectedStore) {
        updateData.discount_code = 'FREEPICKUP';
      }

      fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateData)
      }).catch(err => console.error('Cart update error:', err));
    });

    checkoutBtn.addEventListener('click', async (e) => {
      const selectedStore = select.value;
      
      if (selectedStore) {
        e.preventDefault();
        
        const updateData = {
          attributes: {
            'Pickup Store': selectedStore
          },
          discount_code: 'FREEPICKUP'
        };

        try {
          console.log('Updating cart with:', updateData);
          const response = await fetch('/cart/update.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
          });
          
          const cartData = await response.json();
          console.log('Cart update response:', cartData);
          
          if (response.ok) {
            console.log('Cart updated, redirecting to checkout with discount');
            window.location.href = '/checkout?discount=FREEPICKUP';
          } else {
            console.error('Cart update failed:', cartData);
          }
        } catch (err) {
          console.error('Cart update error:', err);
        }
      }
    });

    checkoutBtn.parentElement.insertBefore(wrapper, checkoutBtn);
  }

  init();

  document.addEventListener('shopify:section:load', init);
  document.addEventListener('shopify:section:reorder', init);
  document.addEventListener('shopify:section:select', init);

  new MutationObserver(init).observe(document.body, {
    childList: true,
    subtree: true
  });
})();
</script>
